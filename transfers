// Get user's current location - FIXED VERSION
getUserLocation() {
    if (!navigator.geolocation) {
        this.showLocationStatus('Geolocation is not supported by your browser', 'error');
        return;
    }

    // Prevent multiple location requests
    if (this.isLocating) {
        this.showLocationStatus('Already getting location...', 'info');
        return;
    }

    this.isLocating = true;
    const locateBtn = document.getElementById('use-my-location');
    const originalHTML = locateBtn.innerHTML;
    locateBtn.innerHTML = '<span class="loading"></span> Locating...';
    locateBtn.disabled = true;

    this.showLocationStatus('Getting your location...', 'info');

    navigator.geolocation.getCurrentPosition(
        (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            
            console.log('Location acquired:', { lat, lng, accuracy });
            
            // Make sure map is initialized and visible
            if (!this.map) {
                this.initMap();
            }
            
            // Show map if not already shown
            if (!this.mapEnabled) {
                this.toggleMap(true);
            }
            
            // Small delay to ensure map is fully loaded
            setTimeout(() => {
                // Add marker at user's location
                this.addMarker([lat, lng], accuracy);
                
                // Update status
                const accuracyMsg = accuracy ? ` (accuracy: Â±${Math.round(accuracy)}m)` : '';
                this.showLocationStatus(`Location acquired${accuracyMsg}`, 'success');
                
                // Update location text field
                const latlng = [lat, lng];
                const latFormatted = latlng[0].toFixed(6);
                const lngFormatted = latlng[1].toFixed(6);
                document.getElementById('location').value = `Lat: ${latFormatted}, Lng: ${lngFormatted}`;
                
                // Center map on marker
                this.map.setView(latlng, Math.max(this.map.getZoom(), 15));
            }, 100);
            
            this.isLocating = false;
            locateBtn.innerHTML = originalHTML;
            locateBtn.disabled = false;
        },
        (error) => {
            console.error('Geolocation error:', error);
            let message = 'Unable to get your location';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = 'Location permission denied. Please enable location services for this site in your browser settings.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'Location information unavailable. Please check your device location settings.';
                    break;
                case error.TIMEOUT:
                    message = 'Location request timed out. Please try again.';
                    break;
                default:
                    message = 'An unknown error occurred while getting location.';
            }
            
            this.showLocationStatus(message, 'error');
            this.isLocating = false;
            locateBtn.innerHTML = originalHTML;
            locateBtn.disabled = false;
        },
        {
            enableHighAccuracy: true,
            timeout: 15000,  // Increased to 15 seconds
            maximumAge: 0    // Don't use cached location
        }
    );
},
